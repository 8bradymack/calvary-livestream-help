<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calvary Livestream Troubleshooting</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            background-attachment: fixed;
            color: #e2e8f0; 
            line-height: 1.6; 
            padding-bottom: 60px;
            min-height: 100vh;
        }
        
        header { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            color: white; 
            padding: 30px 20px 40px; 
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 { 
            font-size: 2em; 
            margin-bottom: 8px; 
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle { font-size: 1em; opacity: 0.8; margin-bottom: 25px; color: #cbd5e1; }
        
        .search-container { max-width: 600px; margin: 0 auto; padding: 0 20px; position: relative; }
        #searchBar { 
            width: 100%; 
            padding: 18px 50px 18px 24px; 
            font-size: 1.1em; 
            border: 2px solid rgba(59, 130, 246, 0.3);
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            outline: none; 
            transition: all 0.3s;
            color: white;
        }
        #searchBar::placeholder { color: #64748b; }
        #searchBar:focus { 
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 8px 32px rgba(0,0,0,0.3);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .search-icons-container { position: absolute; right: 35px; top: 50%; transform: translateY(-50%); }
        .search-icon { color: #64748b; font-size: 1.3em; cursor: default; }
        .clear-search { 
            color: #64748b; 
            font-size: 1.1em; 
            cursor: pointer; 
            background: rgba(51, 65, 85, 0.8);
            border-radius: 50%; 
            width: 28px; 
            height: 28px; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
            font-weight: bold;
        }
        .clear-search:hover { background: rgba(71, 85, 105, 0.9); color: #cbd5e1; }
        .clear-search.active { display: flex; }
        
        .suggestions-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 20px; 
            right: 20px; 
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            margin-top: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            display: none; 
            z-index: 100;
        }
        .suggestions-dropdown.active { display: block; }
        .suggestion-item { 
            padding: 16px 20px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.2s;
        }
        .suggestion-item:hover { background: rgba(59, 130, 246, 0.1); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-question { font-weight: 600; color: #60a5fa; font-size: 0.95em; margin-bottom: 6px; }
        .suggestion-preview { font-size: 0.85em; color: #94a3b8; }
        .suggestion-category { 
            display: inline-block; 
            padding: 3px 10px; 
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-radius: 10px; 
            font-size: 0.7em; 
            font-weight: 600; 
            margin-top: 6px;
        }
        
        .highlight { background: rgba(251, 191, 36, 0.3); padding: 2px 4px; border-radius: 3px; font-weight: 600; color: #fbbf24; }
        .search-stats { text-align: center; color: #94a3b8; font-size: 0.95em; margin: 25px 0 15px; }
        
        .recent-searches { max-width: 600px; margin: 20px auto 0; padding: 0 20px; }
        .recent-searches-title { font-size: 0.85em; color: rgba(255,255,255,0.6); margin-bottom: 10px; font-weight: 600; }
        .recent-tag { 
            display: inline-block; 
            padding: 8px 16px; 
            background: rgba(51, 65, 85, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px; 
            font-size: 0.85em; 
            margin: 4px; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #cbd5e1;
        }
        .recent-tag:hover { 
            border-color: #3b82f6; 
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            transform: translateY(-2px); 
        }
        .clear-recent { 
            display: inline-block; 
            padding: 8px 16px; 
            background: transparent; 
            border: none; 
            color: rgba(255,255,255,0.5);
            font-size: 0.85em; 
            cursor: pointer; 
            margin-left: 8px;
            transition: all 0.2s;
        }
        .clear-recent:hover { color: #ef4444; }
        
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        .emergency-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .emergency-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 2px solid rgba(239, 68, 68, 0.4);
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .emergency-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .emergency-btn:hover::before {
            left: 100%;
        }
        
        .emergency-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        
        .emergency-btn.audio { 
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(202, 138, 4, 0.1) 100%);
            border-color: rgba(234, 179, 8, 0.4);
        }
        .emergency-btn.audio:hover { border-color: #eab308; box-shadow: 0 20px 40px rgba(234, 179, 8, 0.3); }
        
        .emergency-btn.stream { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.4);
        }
        .emergency-btn.stream:hover { border-color: #3b82f6; box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3); }
        
        .emergency-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }
        
        .emergency-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }
        
        .emergency-subtitle {
            font-size: 0.9em;
            color: #94a3b8;
        }
        
        .categories { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            margin-bottom: 35px; 
            justify-content: center;
        }
        
        .category-btn { 
            padding: 12px 24px; 
            background: rgba(51, 65, 85, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 30px; 
            cursor: pointer; 
            font-size: 0.95em; 
            transition: all 0.3s; 
            color: #cbd5e1;
            font-weight: 600;
        }
        .category-btn:hover { 
            border-color: #3b82f6; 
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
        }
        .category-btn.active { 
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; 
            border-color: #3b82f6;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .faq-list { display: flex; flex-direction: column; gap: 20px; }
        
        .faq-item { 
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px; 
            padding: 25px; 
            cursor: pointer; 
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .faq-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .faq-item:hover::before { opacity: 1; }
        
        .faq-item:hover { 
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            transform: translateY(-3px);
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.8);
        }
        
        .faq-item.pinned { border-left: 4px solid #f59e0b; }
        .faq-item.pinned::before { display: none; }
        
        .faq-question { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: #e2e8f0;
            margin-bottom: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        .faq-category { 
            display: inline-block; 
            padding: 6px 14px; 
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-radius: 12px; 
            font-size: 0.75em; 
            font-weight: 600; 
            margin-top: 10px;
        }
        
        .faq-preview { 
            color: #94a3b8;
            font-size: 0.95em; 
            margin-top: 10px; 
            line-height: 1.6;
        }
        .faq-item.expanded .faq-preview { display: none; }
        
        .faq-answer { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            color: #cbd5e1;
            line-height: 1.8; 
            display: none;
        }
        .faq-answer.expanded { display: block; }
        .faq-answer h3 { color: #60a5fa; font-size: 1.1em; margin-top: 20px; margin-bottom: 12px; }
        .faq-answer ul, .faq-answer ol { margin-left: 20px; margin-top: 10px; }
        .faq-answer li { 
            margin-bottom: 10px;
            position: relative;
            padding-left: 10px;
        }
        .faq-answer ol li::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 8px;
            width: 6px;
            height: 6px;
            background: #3b82f6;
            border-radius: 50%;
        }
        .faq-answer strong { color: #60a5fa; }
        
        .step-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 8px 0;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .step-checkbox:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .step-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: #3b82f6;
            flex-shrink: 0;
        }
        
        .step-checkbox label {
            cursor: pointer;
            flex: 1;
            user-select: none;
        }
        
        .step-checkbox.completed label {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .feedback-section {
            margin-top: 25px;
            padding: 20px;
            background: rgba(51, 65, 85, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .feedback-question {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        
        .feedback-buttons {
            display: flex;
            gap: 12px;
        }
        
        .feedback-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            background: rgba(30, 41, 59, 0.6);
            color: #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .feedback-btn.yes {
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .feedback-btn.yes:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #4ade80;
        }
        
        .feedback-btn.no {
            border-color: rgba(239, 68, 68, 0.4);
        }
        
        .feedback-btn.no:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #f87171;
        }
        
        .feedback-thanks {
            color: #4ade80;
            font-weight: 600;
            text-align: center;
            padding: 15px;
            display: none;
        }
        
        .feedback-thanks.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .expand-icon { 
            color: #3b82f6;
            font-size: 1.2em; 
            transition: transform 0.3s;
        }
        .faq-item.expanded .expand-icon { transform: rotate(180deg); }
        
        .section-title { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #e2e8f0;
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        
        .pinned-section { margin-bottom: 50px; }
        .pin-icon { color: #f59e0b; font-size: 1.2em; }
        
        .no-results { 
            text-align: center; 
            padding: 80px 20px; 
            color: #64748b;
            display: none;
        }
        .no-results-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
        .no-results h2 { font-size: 1.8em; margin-bottom: 15px; color: #94a3b8; }
        
        footer { 
            text-align: center; 
            padding: 40px 20px; 
            color: #64748b;
            font-size: 0.9em; 
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            margin-top: 60px;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .report-btn { 
            display: inline-block; 
            margin-top: 20px; 
            padding: 14px 35px; 
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; 
            text-decoration: none; 
            border-radius: 12px; 
            font-weight: 600; 
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        .report-btn:hover { 
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }
        
        .pull-to-refresh { 
            position: fixed; 
            top: -60px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 40px; 
            height: 40px; 
            z-index: 1000; 
            transition: top 0.3s ease;
        }
        .pull-to-refresh.visible { top: 20px; }
        .refresh-spinner { 
            width: 40px; 
            height: 40px; 
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            opacity: 0; 
            transition: opacity 0.3s ease;
        }
        .refresh-spinner.active { opacity: 1; }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.6em; }
            .emergency-actions { grid-template-columns: 1fr; }
            .emergency-btn { padding: 25px; }
            .emergency-icon { font-size: 2.5em; }
        }
    </style>
</head>
<body>
    <div class="pull-to-refresh">
        <div class="refresh-spinner"></div>
    </div>
    
    <header>
        <h1>🎥 Calvary Livestream</h1>
        <p class="subtitle">Emergency Troubleshooting Hub</p>
        <div class="search-container">
            <input type="text" id="searchBar" placeholder="Search: 'no sound', 'camera dark', 'deck broken'..." autocomplete="off">
            <div class="search-icons-container">
                <span class="search-icon" id="searchIcon">🔍</span>
                <span class="clear-search" id="clearSearch">✕</span>
            </div>
            <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
        </div>
        <div class="recent-searches" id="recentSearches" style="display:none;">
            <div class="recent-searches-title">Recent searches:</div>
            <div id="recentTags"></div>
        </div>
    </header>

    <div class="container">
        <div class="emergency-actions" id="emergencyActions">
            <div class="emergency-btn" data-issue="no-sound">
                <span class="emergency-icon">🔇</span>
                <div class="emergency-title">NO AUDIO</div>
                <div class="emergency-subtitle">Fix sound issues instantly</div>
            </div>
            <div class="emergency-btn audio" data-issue="dark-camera">
                <span class="emergency-icon">🌑</span>
                <div class="emergency-title">CAMERA DARK</div>
                <div class="emergency-subtitle">Brightness & exposure fix</div>
            </div>
            <div class="emergency-btn stream" data-issue="stream-down">
                <span class="emergency-icon">📡</span>
                <div class="emergency-title">STREAM DOWN</div>
                <div class="emergency-subtitle">Restream not working</div>
            </div>
        </div>
        
        <div class="search-stats" id="searchStats"></div>
        
        <div class="categories" id="categories">
            <button class="category-btn active" data-category="all">All</button>
            <button class="category-btn" data-category="Setup/Shutdown">Setup/Shutdown</button>
            <button class="category-btn" data-category="Video">Video</button>
            <button class="category-btn" data-category="Audio">Audio</button>
            <button class="category-btn" data-category="Networking">Networking</button>
            <button class="category-btn" data-category="Stream Deck">Stream Deck</button>
            <button class="category-btn" data-category="Software">Software</button>
        </div>

        <div class="pinned-section" id="pinnedSection">
            <h2 class="section-title"><span class="pin-icon">📌</span>Most Common Issues</h2>
            <div class="faq-list" id="pinnedList"></div>
        </div>

        <div id="allSection">
            <h2 class="section-title">All Troubleshooting Guides</h2>
            <div class="faq-list" id="faqList"></div>
        </div>

        <div class="no-results" id="noResults">
            <div class="no-results-icon">🔍</div>
            <h2>No matches found</h2>
            <p>Try different keywords or use the emergency buttons above</p>
        </div>
    </div>

    <footer>
        <p><strong>Last Updated:</strong> October 2025</p>
        <p>Calvary San Mateo A/V Team</p>
        <a href="#" id="reportBtn" class="report-btn">📧 Report an Issue</a>
    </footer>

    <div id="contactModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:1000;padding:20px;">
        <div style="max-width:600px;margin:50px auto;background:rgba(30, 41, 59, 0.95);backdrop-filter:blur(20px);border:1px solid rgba(59, 130, 246, 0.3);border-radius:20px;padding:35px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <h2 style="color:#60a5fa;margin-bottom:15px;font-size:1.8em;">Report an Issue</h2>
            <form id="contactForm" action="https://formspree.io/f/xqayyzrr" method="POST">
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:10px;color:#e2e8f0;">Your Name (Optional)</label>
                    <input type="text" name="name" style="width:100%;padding:14px;border:2px solid rgba(59, 130, 246, 0.3);background:rgba(15, 23, 42, 0.6);color:white;border-radius:10px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:10px;color:#e2e8f0;">Issue Category</label>
                    <select name="category" style="width:100%;padding:14px;border:2px solid rgba(59, 130, 246, 0.3);background:rgba(15, 23, 42, 0.6);color:white;border-radius:10px;">
                        <option value="">Select...</option>
                        <option>Setup/Shutdown</option>
                        <option>Video</option>
                        <option>Audio</option>
                        <option>Networking</option>
                        <option>Stream Deck</option>
                        <option>Software</option>
                        <option>Other</option>
                    </select>
                </div>
                <div style="margin-bottom:25px;">
                    <label style="display:block;font-weight:600;margin-bottom:10px;color:#e2e8f0;">Description *</label>
                    <textarea name="message" required style="width:100%;padding:14px;border:2px solid rgba(59, 130, 246, 0.3);background:rgba(15, 23, 42, 0.6);color:white;border-radius:10px;min-height:150px;"></textarea>
                </div>
                <div style="display:flex;gap:12px;justify-content:flex-end;">
                    <button type="button" id="cancelBtn" style="padding:14px 28px;background:rgba(51, 65, 85, 0.6);color:#cbd5e1;border:2px solid rgba(59, 130, 246, 0.2);border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s;">Cancel</button>
                    <button type="submit" style="padding:14px 28px;background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 8px 20px rgba(59, 130, 246, 0.3);transition:all 0.3s;">Submit</button>
                </div>
            </form>
            <div id="successMessage" style="display:none;margin-top:20px;padding:18px;background:rgba(34, 197, 94, 0.2);border:1px solid rgba(34, 197, 94, 0.4);border-radius:10px;color:#4ade80;font-weight:600;text-align:center;">✓ Submitted!</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    <script>
const faqData=[
{id:1,question:"Complete Startup Procedure",category:"Setup/Shutdown",pinned:true,keywords:"startup start screw power cable",answer:"<h3>Step-by-Step:</h3><ol><li>Turn on ATEM first (screw in power cable)</li><li>Turn on Cameras (flip power strips ON on top of cameras)</li><li>Turn on MacBook (open lid and log in)</li><li>Check Monitors (If Dell and LG don't auto-turn on, click power buttons on bottom right)</li><li>Launch Companion</li><li>Setup QuickTime (New Movie Recording → Input: Blackmagic Design → Drag to LG → Fullscreen)</li><li>Adjust Camera Brightness (ATEM Software → Camera → Adjust Aperture → Gain +14dB)</li><li>Check Audio (Press MIC1 ON → Target: right between green and yellow)</li></ol>"},
{id:2,question:"Complete Shutdown Procedure",category:"Setup/Shutdown",pinned:true,keywords:"shutdown black cloths",answer:"<h3>Step-by-Step:</h3><ol><li>Switch HDMI switch to Input 2 (press SWITCH button)</li><li>Shut down MacBook</li><li>Turn off cameras (both power strips OFF)</li><li>Turn off monitors (press power buttons on bottom right)</li><li>Unplug ATEM last (unscrew power cable)</li><li>Cover equipment (black cloths)</li></ol>"},
{id:3,question:"Cameras look dark or dim",category:"Video",pinned:true,keywords:"dark dim brightness aperture gain",answer:"<h3>Fix Dark Cameras:</h3><ol><li>Open ATEM Software Control</li><li>Go to Camera page</li><li>Drag Aperture to top center</li><li>Set Gain to +14dB</li><li>Adjust until good</li></ol>"},
{id:4,question:"No sound on livestream",category:"Audio",pinned:true,keywords:"no sound audio muted x32 matrix 3.5mm cable green yellow",answer:"<h3>Fix No Audio:</h3><ol><li>Check X32 Matrix NOT muted (ask audio engineer)</li><li>Press MIC1 ON on ATEM (always muted after restart!)</li><li>Check Dell monitor audio bars</li><li>Target: right between green and yellow</li></ol><h3>If still no audio:</h3><ul><li>Check volume arrows under MIC1</li><li>Check 3.5mm audio cable plugged into back left of ATEM</li></ul>"},
{id:5,question:"Restream freezing or disconnecting",category:"Networking",pinned:true,keywords:"restream freezing glitch lag ethernet quicktime recording",answer:"<h3>Fix Restream Freezing:</h3><ol><li><strong>FIRST:</strong> Start recording the stream on QuickTime</li><li>Check internet</li><li>Verify Ethernet (BLUE light on dock)</li><li>Check Dell shows ON AIR + DATA RATE</li><li>Refresh Restream page</li><li>Try Safari instead of Chrome</li></ol><h3>If still freezing:</h3><ul><li>Check ATEM cache</li><li>Unplug and plug back in ethernet on back of ATEM</li></ul>"},
{id:6,question:"ATEM cache filling up or FULL",category:"Networking",pinned:true,keywords:"cache full buffer ethernet quicktime recording sermon",answer:"<h3>⚠️ FIRST: Start recording stream on QuickTime</h3><h3>FIX 1 (Try First):</h3><ol><li>Unplug Ethernet from ATEM back</li><li>Plug back in</li><li>Press MIC1 ON</li></ol><h3>FIX 2 (If not during sermon):</h3><ol><li>Power cycle ATEM (stops video!)</li><li>Wait 5 seconds</li><li>Plug back in</li><li>Press MIC1 ON</li></ol>"},
{id:7,question:"Stream Deck not working",category:"Stream Deck",pinned:true,keywords:"stream deck companion toggle atem",answer:"<h3>FIX 1: Restart Companion</h3><ol><li>Quit Companion</li><li>Reopen</li><li>Test buttons</li></ol><h3>FIX 2 (MOST COMMON):</h3><ol><li>Click Companion in menu bar</li><li>Launch GUI</li><li>Find ATEM connection</li><li>Toggle OFF then ON</li></ol><h3>FIX 3: Hardware</h3><ul><li>Check dock BLUE light</li><li>Check USB plugged in</li></ul><h3>BACKUP:</h3><p>Use ATEM Software → Macros</p>"},
{id:9,question:"QuickTime not showing video to TVs",category:"Software",pinned:false,keywords:"quicktime tv blackmagic usb-c",answer:"<h3>Setup QuickTime:</h3><ol><li>Launch QuickTime</li><li>File → New Movie Recording</li><li>Click dropdown → Choose Blackmagic Design</li><li>Drag to LG monitor</li><li>Click green fullscreen button</li></ol><h3>Troubleshooting:</h3><ul><li>No Blackmagic? Check ATEM powered on and USB-C connected from ATEM to computer</li><li>TVs black? Check HDMI extender/TV inputs</li></ul>"},
{id:12,question:"One TV has no signal (lobby OR patio)",category:"Video",pinned:false,keywords:"tv no signal hdmi input",answer:"<h3>Fix Single TV:</h3><ol><li>Check which HDMI port has cable (back of TV)</li><li>Press Input/Source on remote</li><li>Select matching HDMI (1, 2, or 3)</li><li>Wait a few seconds</li></ol><h3>If still no signal:</h3><ul><li>Check HDMI firmly plugged in</li><li>Power cycle HDMI extender</li></ul>"},
{id:13,question:"BOTH TVs have no signal",category:"Video",pinned:false,keywords:"both tvs hdmi extender flip switch lg monitor",answer:"<h3>Fix Both TVs:</h3><ol><li>Check dock light is BLUE</li><li>Check MacBook + QuickTime fullscreen</li><li>Check USB-C to HDMI adapter (left side)</li><li>Power cycle HDMI extender</li></ol><h3>HDMI Extender Reset:</h3><p><strong>⚠️ Will cut video for LG monitor and all TVs!</strong></p><ol><li>Flip switch off</li><li>Flip switch back on</li></ol>"},
{id:14,question:"Stream Deck completely off",category:"Stream Deck",pinned:false,keywords:"stream deck off dark anker dock power button",answer:"<h3>Fix Stream Deck:</h3><ol><li><strong>Check Anker dock light:</strong><ul><li>OFF = Click power button on front</li><li>GREEN = Fix USB-C from dock to MacBook Pro</li><li>BLUE = Good ✓</li></ul></li><li>If GREEN: Unplug/replug USB-C from MacBook</li><li>Check Stream Deck USB in dock</li><li>Launch Companion</li></ol><h3>Still dark?</h3><ul><li>Try different USB port</li><li>Restart Companion</li></ul>"},
{id:15,question:"Monitor won't turn on automatically",category:"Video",pinned:false,keywords:"monitor auto turn on dell lg shutdown",answer:"<h3>Manual Power On:</h3><p><strong>Dell Curved:</strong> Bottom far right button</p><p><strong>LG Flat:</strong> Bottom right button</p><p><strong>Note:</strong> This is NORMAL - monitors don't auto-turn on if manually turned off during last shutdown</p>"},
{id:16,question:"Docking station green or off",category:"Networking",pinned:false,keywords:"dock anker green off power button",answer:"<h3>If GREEN:</h3><ol><li>Unplug USB-C from MacBook</li><li>Wait 3 seconds</li><li>Replug firmly</li><li>Try other USB-C port</li><li>Should turn BLUE</li></ol><h3>If OFF:</h3><ol><li>Press power button on front of dock</li></ol><h3>Light meanings:</h3><ul><li>BLUE = Good</li><li>GREEN = Bad connection dock to MacBook Pro</li><li>OFF = Powered off or no power</li></ul>"},
{id:19,question:"Lyrics overlay not working",category:"Software",pinned:false,keywords:"lyrics propresenter displaylink launch order camera 4",answer:"<h3>⚠️ Launch Order Matters!</h3><p><strong>DisplayLink MUST launch BEFORE ProPresenter!</strong></p><h3>Fix Lyrics:</h3><ol><li>Quit ProPresenter</li><li>Quit DisplayLink</li><li>Wait 5 seconds</li><li><strong>Launch DisplayLink FIRST</strong></li><li><strong>Launch ProPresenter SECOND</strong></li><li>Check Camera 4</li></ol><p><strong>Why?</strong> DisplayLink creates virtual display. If launched second, ProPresenter can't find it.</p>"},
{id:20,question:"DisplayLink / Camera 4 issues",category:"Software",pinned:false,keywords:"displaylink camera 4 no signal desktop mac mini",answer:"<h3>If No Signal:</h3><ol><li>Launch DisplayLink Manager</li><li>Wait 10-15 seconds</li></ol><h3>If Shows Desktop:</h3><ol><li>Quit ProPresenter + DisplayLink</li><li>Launch DisplayLink FIRST</li><li>Launch ProPresenter SECOND</li></ol><h3>Still broken?</h3><ul><li>Check USB-C from Mac Mini</li><li>Restart both apps</li></ul>"},
{id:21,question:"ATEM not detected on QuickTime and/or ATEM Control app",category:"Video",pinned:false,keywords:"atem not detected quicktime software control sermon power cycle",answer:"<h3>Fix ATEM Not Found:</h3><ol><li>Check power cable (back right, screwed in)</li><li>Restart ATEM Software Control and/or QuickTime (the one not detecting ATEM)</li><li>Check USB/network cables</li><li><strong>Power cycle ATEM ONLY IF NOT DURING SERMON:</strong><ul><li>Unplug power</li><li>Wait 10 seconds</li><li>Plug back in</li><li>Restart software</li></ul></li></ol>"},
{id:24,question:"Restream not streaming to YouTube/Facebook",category:"Networking",pinned:false,keywords:"restream youtube facebook not streaming quicktime recording ethernet",answer:"<h3>⚠️ FIRST: Start recording in QuickTime</h3><h3>Fix Restream Not Live:</h3><ol><li>Quit Chrome</li><li>Open Safari</li><li>Go to Restream.io</li><li>Toggle YouTube/Facebook ON (green)</li><li>Check ATEM cache on Dell monitor</li></ol><h3>Still not streaming?</h3><ul><li>Check ON AIR button lit</li><li>Check Dell shows ON AIR</li><li>Check internet</li><li>Unplug ethernet on back of ATEM</li><li>Wait 5 seconds</li><li>Plug back in</li></ul>"},
{id:25,question:"ON AIR pressed but not streaming",category:"Networking",pinned:false,keywords:"on air not streaming obs ethernet cache",answer:"<h3>Fix ON AIR Not Streaming:</h3><ol><li>Check ATEM ON AIR lit (red)</li><li>Check Dell shows ON AIR in red</li><li>Open Restream.io</li><li>Click Connect to OBS</li><li>Toggle all platforms ON</li></ol><h3>If still not streaming:</h3><ul><li>Press OFF then ON AIR</li><li>Check Ethernet in dock (blue light)</li><li>Refresh Restream page</li><li>Check ATEM cache</li><li>Unplug ethernet on back of ATEM</li><li>Wait 5 seconds</li><li>Plug back in</li></ul>"},
{id:26,question:"Restream shows no camera signal",category:"Networking",pinned:false,keywords:"restream no signal black screen obs ethernet cache",answer:"<h3>Fix No Camera Signal:</h3><ol><li>Check ATEM ON AIR lit</li><li>Check Dell shows ON AIR</li><li>In Restream click Connect to OBS</li><li>Check Ethernet in dock (BLUE light)</li><li>Press OFF then ON AIR on ATEM</li></ol><h3>Still black?</h3><ul><li>Check which camera selected</li><li>Switch cameras and back</li><li>Check ATEM cache</li></ul>"}
];

const advancedSynonyms={
    audio:['sound','volume','mic','microphone','mute','muted','silent','quiet','hear','hearing','mics'],
    video:['picture','screen','display','visual','image','showing','feed','signal'],
    camera:['cam','cameras','cams'],
    dark:['dim','brightness','bright','light','lighting','exposure','black','too dark'],
    atem:['atm','switcher','mixer'],
    restream:['restram','streaming','stream','live','broadcast','broadcasting'],
    glitching:['glitch','freezing','frozen','lagging','lag','stuttering','choppy','buffering','cutting','cuts'],
    broke:['broken','not working','doesnt work','down','failed','failing','issue','problem','wont','cant','help'],
    startup:['start','starting','boot','booting','turn on','power on','setup','beginning'],
    shutdown:['shut down','turn off','power off','close','closing','ending','end'],
    tv:['television','tvs','monitor','screen','display','lobby','patio'],
    deck:['streamdeck','stream deck','elgato','buttons'],
    quicktime:['quick time','qt','recording','record'],
    macbook:['mac','laptop','computer'],
    ethernet:['internet','network','connection','wifi','online'],
    cache:['buffer','full','filling','storage'],
    lyrics:['propresenter','overlay','words','text','songs'],
    displaylink:['camera 4','cam 4','virtual'],
    dell:['curved'],
    lg:['flat'],
    dock:['anker','docking station','hub','usb'],
    green:['light','led','status'],
    blue:['light','led','status']
};

const problemPatterns = [
    {pattern: /no (sound|audio|voice|mic)/i, boost: ['audio', 'sound', 'muted', 'mic1']},
    {pattern: /(dark|dim|bright|black screen|too dark)/i, boost: ['camera', 'dark', 'brightness', 'aperture', 'gain']},
    {pattern: /(freez|lag|glitch|stutter|buffer|chop)/i, boost: ['restream', 'freezing', 'ethernet', 'cache', 'quicktime']},
    {pattern: /(not work|broken|doesn't|down|won't|can't|help|issue|problem)/i, boost: ['troubleshoot']},
    {pattern: /(tv|monitor|screen).*(no signal|black|blank|nothing)/i, boost: ['tv', 'signal', 'hdmi', 'input']},
    {pattern: /cache|full|buffer/i, boost: ['cache', 'full', 'ethernet', 'quicktime', 'recording']},
    {pattern: /deck|button/i, boost: ['stream deck', 'companion', 'toggle']},
    {pattern: /(start|boot|turn on|power on|setup|beginning)/i, boost: ['startup', 'procedure', 'complete']},
    {pattern: /(shut|turn off|close|end)/i, boost: ['shutdown', 'procedure', 'complete']},
    {pattern: /(youtube|facebook|social|platform)/i, boost: ['restream', 'streaming', 'not streaming']},
    {pattern: /on air|streaming|live/i, boost: ['on air', 'restream', 'obs']},
    {pattern: /lyric|propresenter|overlay|song|word/i, boost: ['lyrics', 'propresenter', 'displaylink', 'camera 4']},
    {pattern: /(camera 4|cam 4|displaylink)/i, boost: ['displaylink', 'propresenter', 'virtual']},
    {pattern: /(both|all|multiple).*(tv|monitor)/i, boost: ['both tvs', 'hdmi extender']},
    {pattern: /(one|single|lobby|patio).*(tv|monitor)/i, boost: ['one tv', 'single', 'input']},
    {pattern: /green|blue.*(light|dock)/i, boost: ['dock', 'anker', 'ethernet', 'usb']},
    {pattern: /detect|found|recognize|see/i, boost: ['atem', 'not detected', 'quicktime']},
    {pattern: /(quicktime|recording|record)/i, boost: ['quicktime', 'blackmagic', 'movie']},
    {pattern: /(internet|network|connection|ethernet|wifi)/i, boost: ['ethernet', 'network', 'dock', 'blue light']}
];

// Emergency button mapping
const emergencyMap = {
    'no-sound': 4,
    'dark-camera': 3,
    'stream-down': 5
};

let recentSearches = [];
const MAX_RECENT = 5;

function loadRecentSearches() {
    const stored = {};
    if (stored.recentSearches) {
        recentSearches = stored.recentSearches;
    }
}

function saveRecentSearch(query) {
    if (!query || query.length < 2) return;
    query = query.trim().toLowerCase();
    recentSearches = recentSearches.filter(s => s !== query);
    recentSearches.unshift(query);
    recentSearches = recentSearches.slice(0, MAX_RECENT);
    renderRecentSearches();
}

function renderRecentSearches() {
    const container = document.getElementById('recentSearches');
    const tagsContainer = document.getElementById('recentTags');
    
    if (recentSearches.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    tagsContainer.innerHTML = recentSearches.map(search => 
        `<span class="recent-tag" onclick="applyRecentSearch('${search}')">${search}</span>`
    ).join('') + '<button class="clear-recent" onclick="clearRecentSearches()">Clear</button>';
}

function applyRecentSearch(query) {
    document.getElementById('searchBar').value = query;
    currentSearch = query;
    renderAll();
}

function clearRecentSearches() {
    recentSearches = [];
    renderRecentSearches();
}

function expandSearchQuery(query) {
    let words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
    
    const stopWords = ['a', 'an', 'the', 'or', 'and', 'on', 'in', 'at', 'to', 'for', 'of', 'is', 'are'];
    words = words.filter(w => !stopWords.includes(w) && w !== '/');
    
    let expanded = new Set(words);
    
    words.forEach(word => {
        if (advancedSynonyms[word]) {
            advancedSynonyms[word].forEach(syn => expanded.add(syn));
        }
        
        Object.keys(advancedSynonyms).forEach(key => {
            if (advancedSynonyms[key].includes(word)) {
                expanded.add(key);
                advancedSynonyms[key].forEach(syn => expanded.add(syn));
            }
        });
    });
    
    problemPatterns.forEach(({pattern, boost}) => {
        if (pattern.test(query)) {
            boost.forEach(term => expanded.add(term));
        }
    });
    
    return Array.from(expanded).join(' ');
}

function highlightText(text, searchTerms) {
    if (!searchTerms || searchTerms.length === 0) return text;
    
    const stopWords = ['a', 'an', 'the', 'or', 'and', 'on', 'in', 'at', 'to', 'for', 'of', 'is', 'are'];
    const termsToHighlight = searchTerms.filter(term => !stopWords.includes(term.toLowerCase()) && term.length > 1);
    
    let result = text;
    termsToHighlight.forEach(term => {
        if (term.length < 2) return;
        const regex = new RegExp(`(${term})`, 'gi');
        result = result.replace(regex, '<span class="highlight">$1</span>');
    });
    return result;
}

function intelligentSearch(query) {
    if (!query) return faqData;
    
    const originalQuery = query;
    const expandedQuery = expandSearchQuery(query);
    
    const stopWords = ['a', 'an', 'the', 'or', 'and', 'on', 'in', 'at', 'to', 'for', 'of', 'is', 'are'];
    const searchTerms = query.toLowerCase().split(/\s+/).filter(w => w.length > 1 && !stopWords.includes(w));
    
    const typoMap = {
        'atm': 'atem',
        'restram': 'restream',
        'restrem': 'restream',
        'cam': 'camera',
        'cams': 'camera',
        'mics': 'mic',
        'doesnt': 'doesn\'t',
        'wont': 'won\'t',
        'cant': 'can\'t',
        'youtube': 'restream youtube',
        'facebook': 'restream facebook',
        'fb': 'facebook',
        'yt': 'youtube'
    };
    
    let correctedQuery = query.toLowerCase();
    Object.keys(typoMap).forEach(typo => {
        correctedQuery = correctedQuery.replace(new RegExp('\\b' + typo + '\\b', 'g'), typoMap[typo]);
    });
    
    const fuse = new Fuse(faqData, {
        keys: [
            {name: 'question', weight: 0.45},
            {name: 'keywords', weight: 0.45},
            {name: 'answer', weight: 0.1}
        ],
        threshold: 0.45,
        includeScore: true,
        ignoreLocation: true,
        minMatchCharLength: 2,
        distance: 150,
        useExtendedSearch: true
    });
    
    let results = fuse.search(expandedQuery);
    
    if (results.length < 3) {
        const altResults = fuse.search(correctedQuery);
        results = [...results, ...altResults].filter((v, i, a) => 
            a.findIndex(t => t.item.id === v.item.id) === i
        );
    }
    
    if (results.length < 3) {
        const basicResults = fuse.search(originalQuery);
        results = [...results, ...basicResults].filter((v, i, a) => 
            a.findIndex(t => t.item.id === v.item.id) === i
        );
    }
    
    results = results.map(r => ({
        ...r.item,
        score: r.score,
        searchTerms: searchTerms
    }));
    
    results.forEach(result => {
        let bonusScore = 0;
        
        const questionLower = result.question.toLowerCase();
        const keywordsLower = result.keywords.toLowerCase();
        const answerLower = result.answer.replace(/<[^>]*>/g, '').toLowerCase();
        const combinedText = questionLower + ' ' + keywordsLower + ' ' + answerLower;
        
        if (questionLower.includes(originalQuery.toLowerCase())) {
            bonusScore -= 0.5;
        }
        if (keywordsLower.includes(originalQuery.toLowerCase())) {
            bonusScore -= 0.4;
        }
        
        searchTerms.forEach((term, index) => {
            const isImportantTerm = term.length > 4 || ['atem', 'deck', 'tv'].includes(term);
            const multiplier = isImportantTerm ? 1.5 : 1.0;
            const positionBonus = index === 0 ? 1.2 : 1.0;
            
            if (questionLower.includes(term)) {
                bonusScore -= 0.25 * multiplier * positionBonus;
            }
            if (keywordsLower.includes(term)) {
                bonusScore -= 0.2 * multiplier * positionBonus;
            }
            
            const answerMatches = (answerLower.match(new RegExp('\\b' + term + '\\b', 'g')) || []).length;
            bonusScore -= answerMatches * 0.04;
        });
        
        if (result.pinned) bonusScore -= 0.12;
        
        const allTermsInQuestion = searchTerms.every(term => questionLower.includes(term));
        if (allTermsInQuestion) bonusScore -= 0.4;
        
        const allTermsInKeywords = searchTerms.every(term => keywordsLower.includes(term));
        if (allTermsInKeywords) bonusScore -= 0.35;
        
        const allTermsInCombined = searchTerms.every(term => combinedText.includes(term));
        if (allTermsInCombined) bonusScore -= 0.2;
        
        const matchPercentage = searchTerms.filter(term => 
            questionLower.includes(term) || keywordsLower.includes(term)
        ).length / searchTerms.length;
        bonusScore -= matchPercentage * 0.2;
        
        const problemWords = ['no', 'not', 'won\'t', 'can\'t', 'broken', 'issue', 'problem', 'help'];
        const hasProblemWord = searchTerms.some(term => problemWords.includes(term));
        if (hasProblemWord && questionLower.match(/fix|troubleshoot|issue|problem/i)) {
            bonusScore -= 0.15;
        }
        
        const categoryBoosts = {
            'Setup/Shutdown': ['start', 'startup', 'shutdown', 'boot', 'turn', 'power'],
            'Audio': ['sound', 'audio', 'mic', 'mute', 'volume', 'hear'],
            'Video': ['camera', 'dark', 'bright', 'video', 'picture', 'tv', 'monitor'],
            'Networking': ['internet', 'ethernet', 'network', 'connection', 'stream', 'cache'],
            'Stream Deck': ['deck', 'button', 'companion'],
            'Software': ['quicktime', 'propresenter', 'displaylink', 'software']
        };
        
        Object.keys(categoryBoosts).forEach(cat => {
            if (result.category === cat) {
                const matchingTerms = searchTerms.filter(term => 
                    categoryBoosts[cat].some(boost => boost.includes(term) || term.includes(boost))
                );
                bonusScore -= matchingTerms.length * 0.1;
            }
        });
        
        result.score += bonusScore;
    });
    
    results.sort((a, b) => a.score - b.score);
    
    if (results.length < 2 || (results.length > 0 && results[0].score > 0.7)) {
        const relevantPinned = faqData.filter(f => f.pinned).map(f => ({
            ...f,
            searchTerms: searchTerms,
            score: 0.8
        }));
        results = [...results, ...relevantPinned].filter((v, i, a) => 
            a.findIndex(t => t.id === v.id) === i
        ).sort((a, b) => a.score - b.score);
    }
    
    return results;
}

let suggestionTimeout;

function showSuggestions(query) {
    clearTimeout(suggestionTimeout);
    
    if (!query || query.length < 2) {
        document.getElementById('suggestionsDropdown').classList.remove('active');
        return;
    }
    
    suggestionTimeout = setTimeout(() => {
        const results = intelligentSearch(query).slice(0, 5);
        const dropdown = document.getElementById('suggestionsDropdown');
        
        if (results.length === 0) {
            dropdown.classList.remove('active');
            return;
        }
        
        dropdown.innerHTML = results.map((faq, index) => {
            const cleanAnswer = faq.answer
                .replace(/<\/?(h3|ol|ul|li|p|strong)[^>]*>/gi, ' ')
                .replace(/<[^>]*>/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            const preview = cleanAnswer.substring(0, 80) + '...';
            const highlightedQuestion = highlightText(faq.question, faq.searchTerms);
            
            return `
                <div class="suggestion-item" data-index="${index}" data-id="${faq.id}">
                    <div class="suggestion-question">${highlightedQuestion}</div>
                    <div class="suggestion-preview">${preview}</div>
                    <span class="suggestion-category">${faq.category}</span>
                </div>
            `;
        }).join('');
        
        dropdown.classList.add('active');
        
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                const faqId = parseInt(item.dataset.id);
                const faq = faqData.find(f => f.id === faqId);
                if (faq) {
                    document.getElementById('searchBar').value = faq.question;
                    currentSearch = faq.question;
                    saveRecentSearch(query);
                    renderAll();
                    dropdown.classList.remove('active');
                    
                    setTimeout(() => {
                        const faqElement = document.querySelector(`.faq-item[data-id="${faqId}"]`);
                        if (faqElement) {
                            faqElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            faqElement.click();
                        }
                    }, 100);
                }
            });
        });
    }, 200);
}

let currentCategory = 'all';
let currentSearch = '';

function convertToCheckboxes(htmlContent) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    
    doc.querySelectorAll('ol li, ul li').forEach((li, index) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `step-${Date.now()}-${index}`;
        
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.innerHTML = li.innerHTML;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'step-checkbox';
        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        
        checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                wrapper.classList.add('completed');
            } else {
                wrapper.classList.remove('completed');
            }
        });
        
        li.parentNode.replaceChild(wrapper, li);
    });
    
    return doc.body.innerHTML;
}

function renderFAQ(faq, container) {
    const item = document.createElement('div');
    item.className = `faq-item ${faq.pinned ? 'pinned' : ''}`;
    item.dataset.id = faq.id;
    
    const cleanAnswer = faq.answer
        .replace(/<\/?(h3|ol|ul|li|p|strong)[^>]*>/gi, ' ')
        .replace(/<[^>]*>/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    const preview = cleanAnswer.substring(0, 120) + '...';
    const highlightedQuestion = faq.searchTerms ? highlightText(faq.question, faq.searchTerms) : faq.question;
    const highlightedPreview = faq.searchTerms ? highlightText(preview, faq.searchTerms) : preview;
    
    const answerWithCheckboxes = convertToCheckboxes(faq.answer);
    
    item.innerHTML = `
        <div class="faq-question"><span>${highlightedQuestion}</span><span class="expand-icon">▼</span></div>
        <span class="faq-category">${faq.category}</span>
        <div class="faq-preview">${highlightedPreview}</div>
        <div class="faq-answer">
            ${answerWithCheckboxes}
            <div class="feedback-section">
                <div class="feedback-question">Did this solve your problem?</div>
                <div class="feedback-buttons">
                    <button class="feedback-btn yes">✓ Yes, it worked!</button>
                    <button class="feedback-btn no">✗ No, still broken</button>
                </div>
                <div class="feedback-thanks"></div>
            </div>
        </div>
    `;
    
    item.onclick = (e) => {
        if (e.target.closest('.step-checkbox') || e.target.closest('.feedback-section')) {
            return;
        }
        
        const isExpanded = item.classList.contains('expanded');
        document.querySelectorAll('.faq-answer').forEach(a => a.classList.remove('expanded'));
        document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('expanded'));
        if (!isExpanded) {
            item.classList.add('expanded');
            item.querySelector('.faq-answer').classList.add('expanded');
        }
    };
    
    const yesBtn = item.querySelector('.feedback-btn.yes');
    const noBtn = item.querySelector('.feedback-btn.no');
    const thanksMsg = item.querySelector('.feedback-thanks');
    const feedbackBtns = item.querySelector('.feedback-buttons');
    
    yesBtn.onclick = (e) => {
        e.stopPropagation();
        feedbackBtns.style.display = 'none';
        thanksMsg.textContent = '✓ Great! Glad we could help!';
        thanksMsg.classList.add('show');
    };
    
    noBtn.onclick = (e) => {
        e.stopPropagation();
        feedbackBtns.style.display = 'none';
        thanksMsg.textContent = '📧 Please report this issue so we can improve!';
        thanksMsg.style.color = '#fbbf24';
        thanksMsg.classList.add('show');
        
        setTimeout(() => {
            document.getElementById('reportBtn').click();
        }, 1500);
    };
    
    container.appendChild(item);
}

function renderAll() {
    document.getElementById('pinnedList').innerHTML = '';
    document.getElementById('faqList').innerHTML = '';
    document.getElementById('suggestionsDropdown').classList.remove('active');
    
    let filtered = faqData;
    
    if (currentCategory !== 'all') {
        filtered = faqData.filter(f => f.category === currentCategory);
    }
    
    if (currentSearch) {
        filtered = intelligentSearch(currentSearch);
        document.getElementById('pinnedSection').style.display = 'none';
        document.getElementById('emergencyActions').style.display = 'none';
        
        if (filtered.length === 0) {
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('faqList').style.display = 'none';
            document.getElementById('searchStats').textContent = '';
            return;
        } else {
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('faqList').style.display = 'flex';
            document.getElementById('searchStats').textContent = `Found ${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
        }
        
        filtered.forEach(f => renderFAQ(f, document.getElementById('faqList')));
        
        saveRecentSearch(currentSearch);
    } else {
        document.getElementById('pinnedSection').style.display = 'block';
        document.getElementById('emergencyActions').style.display = 'grid';
        document.getElementById('noResults').style.display = 'none';
        document.getElementById('faqList').style.display = 'flex';
        document.getElementById('searchStats').textContent = '';
        
        const pinned = filtered.filter(f => f.pinned);
        pinned.forEach(f => renderFAQ(f, document.getElementById('pinnedList')));
        filtered.filter(f => !f.pinned).forEach(f => renderFAQ(f, document.getElementById('faqList')));
    }
}

const searchBar = document.getElementById('searchBar');
const clearSearchBtn = document.getElementById('clearSearch');
const searchIcon = document.getElementById('searchIcon');

searchBar.addEventListener('input', e => {
    currentSearch = e.target.value.trim();
    
    if (e.target.value) {
        clearSearchBtn.classList.add('active');
        searchIcon.style.display = 'none';
    } else {
        clearSearchBtn.classList.remove('active');
        searchIcon.style.display = 'block';
    }
    
    showSuggestions(currentSearch);
    if (!currentSearch) renderAll();
});

searchBar.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        renderAll();
    }
});

clearSearchBtn.addEventListener('click', () => {
    searchBar.value = '';
    currentSearch = '';
    clearSearchBtn.classList.remove('active');
    searchIcon.style.display = 'block';
    renderAll();
    searchBar.focus();
});

document.addEventListener('click', e => {
    if (!e.target.closest('.search-container')) {
        document.getElementById('suggestionsDropdown').classList.remove('active');
    }
});

document.querySelectorAll('.category-btn').forEach(btn => btn.onclick = () => {
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentCategory = btn.dataset.category;
    document.getElementById('searchBar').value = '';
    currentSearch = '';
    renderAll();
});

document.querySelectorAll('.emergency-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const issueType = btn.dataset.issue;
        const faqId = emergencyMap[issueType];
        const faq = faqData.find(f => f.id === faqId);
        
        if (faq) {
            document.getElementById('searchBar').value = faq.question;
            currentSearch = faq.question;
            renderAll();
            
            setTimeout(() => {
                const faqElement = document.querySelector(`.faq-item[data-id="${faqId}"]`);
                if (faqElement) {
                    faqElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    faqElement.click();
                }
            }, 100);
        }
    });
});

document.getElementById('reportBtn').onclick = e => {
    e.preventDefault();
    document.getElementById('contactModal').style.display = 'block';
};

document.getElementById('cancelBtn').onclick = () => {
    document.getElementById('contactModal').style.display = 'none';
};

document.getElementById('contactModal').onclick = e => {
    if (e.target.id === 'contactModal') {
        document.getElementById('contactModal').style.display = 'none';
    }
};

document.getElementById('contactForm').onsubmit = async e => {
    e.preventDefault();
    const res = await fetch(e.target.action, {
        method: 'POST',
        body: new FormData(e.target),
        headers: {'Accept': 'application/json'}
    });
    if (res.ok) {
        document.getElementById('contactForm').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
        setTimeout(() => document.getElementById('contactModal').style.display = 'none', 3000);
    }
};

const pullToRefreshElement = document.querySelector('.pull-to-refresh');
const refreshSpinner = document.querySelector('.refresh-spinner');

let touchStartY = 0;
let touchCurrentY = 0;
let isPulling = false;
let isRefreshing = false;
const pullThreshold = 80;

document.addEventListener('touchstart', e => {
    if (window.scrollY === 0 && !isRefreshing) {
        touchStartY = e.touches[0].clientY;
        touchCurrentY = touchStartY;
        isPulling = true;
    }
}, { passive: true });

document.addEventListener('touchmove', e => {
    if (!isPulling || isRefreshing) return;
    
    if (window.scrollY === 0) {
        touchCurrentY = e.touches[0].clientY;
        const pullDistance = touchCurrentY - touchStartY;
        
        if (pullDistance > 0) {
            const progress = Math.min(pullDistance / pullThreshold, 1);
            refreshSpinner.style.opacity = progress;
            const spinnerOffset = Math.min(pullDistance * 0.5, 60);
            pullToRefreshElement.style.top = `${-60 + spinnerOffset}px`;
            
            if (pullDistance > pullThreshold) {
                refreshSpinner.classList.add('active');
            } else {
                refreshSpinner.classList.remove('active');
            }
        }
    } else {
        isPulling = false;
        resetPullToRefresh();
    }
}, { passive: true });

document.addEventListener('touchend', () => {
    if (!isPulling || isRefreshing) return;
    
    const pullDistance = touchCurrentY - touchStartY;
    
    if (pullDistance > pullThreshold) {
        isRefreshing = true;
        pullToRefreshElement.classList.add('visible');
        refreshSpinner.classList.add('active');
        refreshSpinner.style.opacity = '1';
        
        setTimeout(() => {
            location.reload();
        }, 300);
    } else {
        resetPullToRefresh();
    }
    
    isPulling = false;
});

function resetPullToRefresh() {
    pullToRefreshElement.style.top = '-60px';
    refreshSpinner.classList.remove('active');
    refreshSpinner.style.opacity = '0';
    pullToRefreshElement.classList.remove('visible');
}

window.addEventListener('scroll', () => {
    if (window.scrollY > 0 && isPulling) {
        isPulling = false;
        resetPullToRefresh();
    }
});

loadRecentSearches();
renderRecentSearches();
renderAll();
    </script>
</body>
</html>